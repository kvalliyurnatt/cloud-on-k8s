# CVE Triage Agent for ECK

This tool automatically triages CVE reports from GitHub issues and determines if they affect ECK (Elastic Cloud on Kubernetes) dependencies or codebase.

## Features

- **CVE Parsing**: Extracts CVE IDs from issue titles and bodies
- **NVD Integration**: Fetches CVE details from the National Vulnerability Database
- **Dependency Analysis**: Checks ECK's `go.mod` for affected dependencies (both direct and transitive)
- **govulncheck Integration**: Runs Go's official vulnerability scanner to detect if vulnerable code paths are actually called
- **AI Analysis**: Uses Google Gemini to provide intelligent assessment of CVE impact
- **GitHub Integration**: Posts triage reports as issue comments

## Prerequisites

- Go 1.24+
- GitHub token with repo access
- (Optional) govulncheck for deep vulnerability scanning
- (Optional) Gemini API key for AI-powered analysis
- (Optional) NVD API key for faster CVE lookups

## Installation

```bash
cd hack/cve-triage
go build -o cve-triage .

# Install govulncheck for deeper analysis
go install golang.org/x/vuln/cmd/govulncheck@latest
```

## Usage

### Command Line

```bash
# Basic usage with dry run (doesn't post to GitHub)
./cve-triage \
  --issue-title="CVE-2024-12345 - Security vulnerability in x/crypto" \
  --issue-body="This CVE affects golang.org/x/crypto..." \
  --dry-run

# Full usage with GitHub posting
GITHUB_TOKEN=your_token \
GEMINI_API_KEY=your_gemini_key \
./cve-triage \
  --issue-number=123 \
  --issue-title="CVE-2024-12345" \
  --issue-body="..." \
  --owner=elastic \
  --repo=security

# Skip govulncheck for faster analysis
./cve-triage \
  --issue-title="CVE-2024-12345" \
  --issue-body="..." \
  --skip-vulncheck \
  --dry-run
```

### Environment Variables

| Variable | Description |
|----------|-------------|
| `GITHUB_TOKEN` | GitHub personal access token (required for posting comments) |
| `GEMINI_API_KEY` | Google Gemini API key (optional, enables AI analysis) |
| `NVD_API_KEY` | NVD API key (optional, for faster CVE lookups) |

### Command Line Flags

| Flag | Description | Default |
|------|-------------|---------|
| `--issue-number` | GitHub issue number | - |
| `--issue-title` | Issue title | - |
| `--issue-body` | Issue body content | - |
| `--go-mod` | Path to ECK's go.mod | `go.mod` |
| `--repo-path` | Path to ECK repository root (for govulncheck) | - |
| `--owner` | GitHub repository owner | `elastic` |
| `--repo` | GitHub repository name | `security` |
| `--dry-run` | Print report without posting | `false` |
| `--add-labels` | Add triage labels to issue | `false` |
| `--skip-vulncheck` | Skip govulncheck scan | `false` |
| `--github-token` | GitHub token | - |
| `--gemini-api-key` | Gemini API key | - |
| `--nvd-api-key` | NVD API key | - |

## GitHub Actions Integration

To run this tool automatically when issues are created in the security repo, add the following workflow to the **elastic/security** repository:

```yaml
# .github/workflows/eck-cve-triage.yml
name: ECK CVE Triage

on:
  issues:
    types: [opened, labeled]

jobs:
  triage:
    if: contains(github.event.issue.labels.*.name, 'ECK')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ECK repository
        uses: actions/checkout@v4
        with:
          repository: elastic/cloud-on-k8s
          ref: main

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run CVE Triage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd hack/cve-triage
          go run . \
            --issue-number=${{ github.event.issue.number }} \
            --issue-title="${{ github.event.issue.title }}" \
            --issue-body="${{ github.event.issue.body }}" \
            --owner=${{ github.repository_owner }} \
            --repo=security \
            --repo-path=../.. \
            --add-labels
```

## Example Output

When run against an issue, the tool posts a comment like this:

```markdown
## üîç ECK CVE Triage Report

**CVE**: CVE-2024-12345
**Severity**: HIGH (CVSS: 8.1)

### üü† Risk Level: **MEDIUM**

### CVE Description
A vulnerability in the SSH certificate parsing allows...

### Dependency Analysis
**Direct Dependencies:**
- ‚úÖ `golang.org/x/crypto@v0.21.0` (matched: crypto)
  - ECK uses v0.21.0 which is outside the affected range < v0.17.0

### govulncheck Scan
‚úÖ govulncheck found no vulnerabilities affecting ECK.

### AI Analysis
**Summary:**
While ECK uses golang.org/x/crypto, it only uses TLS-related functionality.
The vulnerable SSH certificate parsing code is not invoked by ECK.

### Recommendation
No immediate action required. Consider updating dependency in next release cycle.

*Analysis Confidence: HIGH*
```

## How govulncheck Helps

[govulncheck](https://pkg.go.dev/golang.org/x/vuln/cmd/govulncheck) is the official Go vulnerability scanner. Unlike simple dependency matching, it:

1. **Analyzes call graphs**: Only reports vulnerabilities in code paths that are actually reachable
2. **Reduces false positives**: Won't flag a vulnerability if your code never calls the affected function
3. **Provides call stacks**: Shows exactly how your code reaches the vulnerable function

For example, if a CVE affects `golang.org/x/crypto/ssh` but ECK only uses `golang.org/x/crypto/tls`, govulncheck will report "no vulnerabilities found" even though the dependency is present.

## Architecture

```
hack/cve-triage/
‚îú‚îÄ‚îÄ main.go              # CLI entrypoint and orchestration
‚îú‚îÄ‚îÄ go.mod               # Go module definition
‚îú‚îÄ‚îÄ go.sum               # Dependency checksums
‚îú‚îÄ‚îÄ README.md            # This file
‚îî‚îÄ‚îÄ internal/
    ‚îú‚îÄ‚îÄ parser/
    ‚îÇ   ‚îî‚îÄ‚îÄ cve.go       # CVE ID extraction and NVD API client
    ‚îú‚îÄ‚îÄ deps/
    ‚îÇ   ‚îî‚îÄ‚îÄ checker.go   # go.mod parsing and dependency matching
    ‚îú‚îÄ‚îÄ vulncheck/
    ‚îÇ   ‚îî‚îÄ‚îÄ scanner.go   # govulncheck integration
    ‚îú‚îÄ‚îÄ llm/
    ‚îÇ   ‚îî‚îÄ‚îÄ analyzer.go  # Gemini AI integration
    ‚îî‚îÄ‚îÄ github/
        ‚îî‚îÄ‚îÄ reporter.go  # GitHub API client for comments/labels
```

## Analysis Pipeline

```
1. Parse CVE ID from issue ‚Üí Extract CVE-XXXX-XXXXX
                               ‚Üì
2. Fetch NVD data        ‚Üí Get severity, affected packages, description
                               ‚Üì
3. Dependency check      ‚Üí Match against ECK's go.mod (direct + transitive)
                               ‚Üì
4. govulncheck scan      ‚Üí Deep analysis of actual code paths
                               ‚Üì
5. AI analysis           ‚Üí Gemini assesses risk considering ECK's usage
                               ‚Üì
6. Generate report       ‚Üí Post formatted comment to GitHub issue
```

## Development

### Running Tests

```bash
go test ./...
```

### Building

```bash
go build -o cve-triage .
```

### Testing Locally

```bash
# Quick test with dry-run
./cve-triage \
  --dry-run \
  --issue-title="CVE-2024-45337 - golang.org/x/crypto vulnerability" \
  --issue-body="Affects SSH certificate verification"

# With govulncheck (takes longer but more accurate)
./cve-triage \
  --dry-run \
  --repo-path=/path/to/cloud-on-k8s \
  --issue-title="CVE-2024-45337" \
  --issue-body="..."
```

## License

Elastic License 2.0
